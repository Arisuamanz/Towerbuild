<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tower Pillar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1; /* Indigo-500 */
            --primary-hover: #4f46e5; /* Indigo-600 */
            --accent: #f59e0b; /* Amber-500 */
            --bg-dark: #0f172a; /* Slate-900 */
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-dark);
            touch-action: none;
            font-family: 'Poppins', sans-serif;
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            max-width: 480px; 
            margin: 0 auto;
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 100%);
            overflow: hidden;
            box-shadow: 0 0 40px rgba(0,0,0,0.6);
            transition: transform 0.1s;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI Overlays */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .hud {
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: linear-gradient(to bottom, rgba(0,0,0,0.5) 0%, transparent 100%);
            transition: opacity 0.5s ease;
        }
        
        .hud.hide {
            opacity: 0;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
        }

        /* Typography */
        .score-text {
            font-size: 3rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 4px 10px rgba(0,0,0,0.4);
            line-height: 1;
        }

        .combo-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--accent);
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            min-height: 2rem; 
            margin-top: 4px;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
        }
        
        .combo-animate {
            transform: scale(1.2);
            opacity: 1 !important;
        }

        /* TIER SYSTEM STYLING */
        .tier-badge {
            font-weight: 900;
            margin-left: 6px;
            display: inline-block;
            font-style: italic;
        }
        
        /* D: 0-24 */
        .tier-D { 
            color: #9ca3af; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        /* C: 25-49 */
        .tier-C { 
            color: #4ade80; 
            text-shadow: 0 0 10px rgba(74,222,128,0.5), 0 2px 4px rgba(0,0,0,0.5); 
        }
        
        /* B: 50-74 */
        .tier-B {
            background: linear-gradient(135deg, #60a5fa, #2563eb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 8px rgba(59,130,246,0.8));
        }
        
        /* A: 75-99 */
        .tier-A {
            background: linear-gradient(135deg, #e879f9, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 15px rgba(168,85,247,0.9));
        }
        
        /* S: 100+ */
        .tier-S {
            background: linear-gradient(135deg, #fef08a, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 20px rgba(245,158,11,1));
            animation: shine-s 1.5s ease-in-out infinite alternate;
        }
        
        @keyframes shine-s {
            from { filter: drop-shadow(0 0 10px rgba(245,158,11,0.8)); transform: scale(1); }
            to { filter: drop-shadow(0 0 25px rgba(254,240,138,1)); transform: scale(1.1); }
        }

        /* Screens */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: white;
            pointer-events: auto;
            z-index: 10;
            opacity: 1;
            transition: opacity 0.8s ease; 
        }

        .screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Buttons */
        .btn {
            background: var(--primary);
            color: white;
            padding: 16px 40px;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 1.25rem;
            letter-spacing: 0.05em;
            border: 2px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3), inset 0 -4px 0 rgba(0,0,0,0.2);
            pointer-events: auto;
            margin-top: 20px;
        }

        .btn:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(99, 102, 241, 0.4), inset 0 -4px 0 rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 5px rgba(99, 102, 241, 0.3), inset 0 -2px 0 rgba(0,0,0,0.2);
        }

        .btn-accent {
            background: var(--accent);
            color: #78350f;
            box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3), inset 0 -4px 0 rgba(0,0,0,0.15);
        }
        
        .btn-accent:hover {
            background: #d97706; 
            color: white;
            box-shadow: 0 12px 24px rgba(217, 119, 6, 0.4), inset 0 -4px 0 rgba(0,0,0,0.15);
        }

        /* Title Styling */
        .title-container {
            text-align: center;
            margin-bottom: 2rem;
            animation: float 3s ease-in-out infinite;
        }

        .game-title {
            font-size: 3.5rem;
            font-weight: 800;
            line-height: 1.1;
            background: linear-gradient(135deg, #fff 0%, #cbd5e1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
        }

        .game-subtitle {
            color: #94a3b8;
            font-size: 1.1rem;
            margin-top: 10px;
            font-weight: 400;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        /* Floating Text Effects */
        .floating-text {
            position: absolute;
            font-weight: 800;
            pointer-events: none;
            z-index: 5;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
        }

        .perfect-text {
            color: var(--accent);
            font-size: 2.2rem;
            text-shadow: 0 0 10px rgba(245, 158, 11, 0.8), 0 2px 4px rgba(0,0,0,0.5);
            animation: popUpFade 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        
        .good-text {
            color: #10b981; 
            font-size: 1.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            animation: popUpFade 1.2s ease-out forwards;
        }

        @keyframes popUpFade {
            0% { opacity: 0; transform: translate(-50%, 20px) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, 0px) scale(1.1); }
            80% { opacity: 1; transform: translate(-50%, -30px) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50px) scale(0.9); }
        }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <!-- Heads Up Display -->
    <div class="ui-layer hud" id="hud-layer">
        <div class="flex flex-col">
            <div class="score-text" id="score-display">0</div>
            <div class="combo-text" id="combo-display"></div>
        </div>
        <!-- Highscore HUD with Tier -->
        <div class="flex flex-col items-end glass-panel px-4 py-2">
            <div class="text-[10px] text-gray-300 uppercase tracking-wider font-bold">HIGH SCORE</div>
            <div class="text-2xl font-bold text-white drop-shadow-md">
                <span id="highscore-display">0</span>
                <span id="hud-tier"></span>
            </div>
        </div>
    </div>

    <!-- Container untuk efek teks terapung -->
    <div id="fx-container" class="ui-layer"></div>

    <!-- Start Screen -->
    <div id="start-screen" class="screen">
        <div class="title-container">
            <h1 class="game-title">TOWER<br><span class="text-indigo-400">PILLAR</span></h1>
            <p class="game-subtitle">Perfect Landing +3 Points</p>
        </div>
        
        <!-- Papan Highscore -->
        <div class="glass-panel px-8 py-4 mb-6 text-center shadow-lg border-yellow-500/30 border min-w-[240px]">
            <p class="text-xs text-gray-400 uppercase tracking-wider mb-1 font-bold">CURRENT RECORD</p>
            <p class="text-4xl font-black text-white drop-shadow-md">
                <span id="start-highscore">0</span> 
                <span class="text-lg text-gray-400 font-normal">PTS</span>
                <span id="start-tier"></span>
            </p>
        </div>
        
        <div class="text-center mb-2 px-6">
            <p class="text-sm text-gray-300 leading-relaxed">
                Build the pillar as high as possible.<br>
                <span class="text-red-400 font-bold">Game over if the block misses or only hits the edge!</span>
            </p>
        </div>
        
        <button class="btn" id="start-btn">START BUILDING</button>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="screen hidden">
        <h1 class="text-5xl font-black mb-2 text-red-500" style="text-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);">MISSED!</h1>
        
        <div class="glass-panel p-8 mx-6 text-center my-6 w-3/4 max-w-sm relative">
            <!-- Badge Rekod Baru -->
            <div id="new-record-badge" class="hidden absolute -top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white text-xs font-bold px-4 py-1 rounded-full shadow-lg border-2 border-green-300 animate-pulse">
                NEW RECORD!
            </div>

            <p class="text-gray-400 text-sm uppercase tracking-wider mb-1">TOTAL SCORE</p>
            <p class="text-5xl font-black text-white mb-4"><span id="final-score">0</span></p>
            
            <div class="w-full h-px bg-gray-700 my-4"></div>
            
            <p class="text-gray-400 text-xs uppercase tracking-wider mb-1">HIGH SCORE</p>
            <p class="text-3xl font-bold text-white drop-shadow-md">
                <span id="final-highscore">0</span>
                <span id="final-tier"></span>
            </p>
        </div>
        
        <button class="btn btn-accent" id="restart-btn">PLAY AGAIN</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('game-container');
    const hudLayer = document.getElementById('hud-layer');
    
    // Elemen UI
    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const scoreDisplay = document.getElementById('score-display');
    const comboDisplay = document.getElementById('combo-display');
    const fxContainer = document.getElementById('fx-container');
    const startBtn = document.getElementById('start-btn');
    const restartBtn = document.getElementById('restart-btn');
    const newRecordBadge = document.getElementById('new-record-badge');

    // --- TIER SYSTEM LOGIC ---
    function updateHighscoreUI(scoreVal) {
        // Set Nombor
        document.getElementById('highscore-display').innerText = scoreVal;
        document.getElementById('start-highscore').innerText = scoreVal;
        document.getElementById('final-highscore').innerText = scoreVal;

        // Tentukan Tier
        let rank = 'D';
        let className = 'tier-D';
        
        if (scoreVal >= 100) { rank = 'S'; className = 'tier-S'; }
        else if (scoreVal >= 75) { rank = 'A'; className = 'tier-A'; }
        else if (scoreVal >= 50) { rank = 'B'; className = 'tier-B'; }
        else if (scoreVal >= 25) { rank = 'C'; className = 'tier-C'; }

        // Bina span element untuk efek tier
        const tierHTML = `<span class="tier-badge ${className}">${rank}</span>`;
        
        // Letak pada semua UI
        document.getElementById('hud-tier').innerHTML = tierHTML;
        document.getElementById('start-tier').innerHTML = tierHTML;
        document.getElementById('final-tier').innerHTML = tierHTML;
    }

    // Dapatkan Highscore dari LocalStorage dan terus kemas kini UI bersama Tier
    let highScore = parseInt(localStorage.getItem('towerPillarHighScore')) || 0;
    updateHighscoreUI(highScore);

    // --- PEMALAR BENTUK TIANG KURUS ---
    const BLOCK_WIDTH = 45;  
    const BLOCK_HEIGHT = 140; 
    
    // --- KELAJUAN HAYUNAN (DINAMIK) ---
    const BASE_SWING_SPEED = 0.018; 
    let currentSwingSpeed = BASE_SWING_SPEED; 
    const MAX_SWING_ANGLE = Math.PI / 5; 
    
    const GRAVITY = 0.45; 
    const CAMERA_SPEED = 0.04; 
    
    const PERFECT_TOLERANCE = 5;

    // Keadaan Permainan
    let state = 'START'; 
    let blocks = [];
    let currentBlock = null;
    let cameraY = 0;
    let targetCameraY = 0;
    let score = 0;     
    let combo = 0;
    let time = 0;
    let lastTime = 0; 
    let clouds = [];

    // Skema Warna Latar Belakang
    const bgGradients = [
        {h: 0,  top: '#87CEEB', bottom: '#E0F6FF'}, 
        {h: 12, top: '#4facfe', bottom: '#00f2fe'}, 
        {h: 24, top: '#fa709a', bottom: '#fee140'}, 
        {h: 36, top: '#30cfd0', bottom: '#330867'}, 
        {h: 50, top: '#0f172a', bottom: '#1e1b4b'}, 
        {h: 70, top: '#000000', bottom: '#09090b'}  
    ];

    // Palet Warna Blok
    const blockPalettes = [
        { main: '#ef4444', light: '#f87171', dark: '#b91c1c' }, 
        { main: '#3b82f6', light: '#60a5fa', dark: '#1d4ed8' }, 
        { main: '#10b981', light: '#34d399', dark: '#047857' }, 
        { main: '#f59e0b', light: '#fbbf24', dark: '#b45309' }, 
        { main: '#8b5cf6', light: '#a78bfa', dark: '#6d28d9' }, 
        { main: '#ec4899', light: '#f472b6', dark: '#be185d' }  
    ];

    function initClouds() {
        clouds = [];
        for(let i=0; i<8; i++) {
            clouds.push({
                x: Math.random() * 500,
                y: Math.random() * 800 - 400,
                speed: 0.05 + Math.random() * 0.1, 
                scale: 0.5 + Math.random() * 1.5,
                opacity: 0.3 + Math.random() * 0.4
            });
        }
    }

    function resizeCanvas() {
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        if (state === 'START') {
            initClouds();
            draw();
        }
    }
    window.addEventListener('resize', resizeCanvas);

    function initGame() {
        blocks = [];
        score = 0;
        combo = 0;
        time = 0;
        lastTime = 0; 
        cameraY = 0;
        targetCameraY = 0;
        currentSwingSpeed = BASE_SWING_SPEED; 
        
        initClouds();
        hudLayer.classList.remove('hide');
        newRecordBadge.classList.add('hidden');

        // Blok Tapak (Base)
        blocks.push({
            x: canvas.width / 2,
            y: canvas.height - (BLOCK_HEIGHT * 1.2),
            width: BLOCK_WIDTH * 1.8,
            height: BLOCK_HEIGHT * 1.2,
            color: { main: '#475569', light: '#64748b', dark: '#334155' }, 
            offset: 0,
            angle: 0
        });

        spawnBlock();
        updateUIText();
        state = 'PLAYING';
        
        startScreen.classList.add('hidden');
        gameOverScreen.classList.add('hidden');
        fxContainer.innerHTML = '';
        container.style.transform = 'translate(0, 0)';
        
        requestAnimationFrame(gameLoop);
    }

    function spawnBlock() {
        const topBlockY = blocks[blocks.length - 1].y;
        targetCameraY = Math.max(0, canvas.height - topBlockY - (canvas.height * 0.4)); 
        
        const randomPalette = blockPalettes[Math.floor(Math.random() * blockPalettes.length)];
        
        currentBlock = {
            x: canvas.width / 2,
            y: -targetCameraY - 200, 
            width: BLOCK_WIDTH,
            height: BLOCK_HEIGHT,
            color: randomPalette,
            state: 'SWINGING',
            angle: 0,
            velocity: 0
        };
    }

    function dropBlock() {
        if (state !== 'PLAYING' || !currentBlock || currentBlock.state !== 'SWINGING') return;
        currentBlock.state = 'FALLING';
        
        const craneY = -cameraY - 120;
        const ropeLength = 250; 
        currentBlock.x = canvas.width/2 + Math.sin(currentBlock.angle) * ropeLength;
        currentBlock.y = craneY + Math.cos(currentBlock.angle) * ropeLength;
    }

    function createFloatingText(text, yPos, type = 'perfect') {
        const el = document.createElement('div');
        el.className = `floating-text ${type}-text`;
        el.innerText = text;
        
        const screenY = yPos + cameraY - 20;
        el.style.top = `${screenY}px`;
        
        const randomX = (Math.random() - 0.5) * 40;
        el.style.marginLeft = `${randomX}px`;
        
        fxContainer.appendChild(el);
        setTimeout(() => el.remove(), 1500);
    }

    function updatePlaying(delta) {
        cameraY += (targetCameraY - cameraY) * CAMERA_SPEED * delta;

        if (currentBlock) {
            if (currentBlock.state === 'SWINGING') {
                currentBlock.angle = Math.sin(time * currentSwingSpeed) * MAX_SWING_ANGLE;
            } 
            else if (currentBlock.state === 'FALLING') {
                currentBlock.velocity += GRAVITY * delta;
                currentBlock.y += currentBlock.velocity * delta;

                const topBlock = blocks[blocks.length - 1];
                const topBlockRealX = topBlock.x; 

                if (currentBlock.y + currentBlock.height >= topBlock.y) {
                    
                    const diffX = currentBlock.x - topBlockRealX;
                    const maxAllowedDiff = BLOCK_WIDTH * 0.70; 
                    const isStable = Math.abs(diffX) <= maxAllowedDiff;
                    
                    if (isStable) {
                        currentBlock.state = 'DROPPED';
                        currentBlock.y = topBlock.y - currentBlock.height; 

                        let isPerfect = Math.abs(diffX) < PERFECT_TOLERANCE;
                        
                        if (isPerfect) {
                            currentBlock.x = topBlockRealX; 
                            combo++;
                            score += 3; // +3 Points
                            createFloatingText("PERFECT! +3", currentBlock.y, 'perfect');
                            triggerComboAnimation();
                        } else {
                            combo = 0;
                            score += 1; // +1 Point
                            createFloatingText("GOOD +1", currentBlock.y, 'good');
                        }

                        currentSwingSpeed += 0.001; 

                        currentBlock.angle = 0; 
                        blocks.push(currentBlock);
                        
                        updateUIText();
                        
                        currentBlock = null;
                        spawnBlock();
                    } else {
                        currentBlock.state = 'FALLING_OFF';
                        combo = 0;
                        updateUIText();
                        
                        state = 'MISSED';
                        shakeScreen(10, 300);
                        hudLayer.classList.add('hide'); 
                    }
                }
            }
            else if (currentBlock.state === 'FALLING_OFF') {
                currentBlock.velocity += GRAVITY * delta;
                currentBlock.y += currentBlock.velocity * delta;
                currentBlock.x += ((currentBlock.x > canvas.width/2) ? 2.5 : -2.5) * delta;

                if (currentBlock.y > -cameraY + canvas.height + 200) {
                    currentBlock = null;
                    if (state === 'MISSED') {
                        gameOver(); 
                    }
                }
            }
        }
    }

    function update(delta) {
        time += 1 * delta; 
        
        clouds.forEach(cloud => {
            cloud.x += cloud.speed * delta;
            if (cloud.x > canvas.width + 100) cloud.x = -100;
        });

        if (state === 'PLAYING' || state === 'MISSED') {
            updatePlaying(delta);
        }
    }

    function shakeScreen(intensity, duration) {
        let startTime = Date.now();
        let shake = setInterval(() => {
            let elapsed = Date.now() - startTime;
            if (elapsed > duration) {
                clearInterval(shake);
                container.style.transform = 'translate(0, 0)';
                return;
            }
            let currIntensity = intensity * (1 - (elapsed/duration));
            let dx = (Math.random() - 0.5) * currIntensity * 2;
            let dy = (Math.random() - 0.5) * currIntensity * 2;
            container.style.transform = `translate(${dx}px, ${dy}px)`;
        }, 30);
    }

    function triggerComboAnimation() {
        comboDisplay.classList.remove('combo-animate');
        void comboDisplay.offsetWidth;
        comboDisplay.classList.add('combo-animate');
    }

    function gameOver() {
        state = 'GAMEOVER';
        
        let isNewRecord = false;
        
        if (score > highScore) {
            highScore = score;
            localStorage.setItem('towerPillarHighScore', highScore);
            isNewRecord = true;
        }
        
        // Kemas kini UI termasuk Tier Element
        updateHighscoreUI(highScore);
        
        document.getElementById('final-score').innerText = score;
        
        if (isNewRecord && score > 0) {
            newRecordBadge.classList.remove('hidden');
        }

        gameOverScreen.classList.remove('hidden');
    }

    function updateUIText() {
        scoreDisplay.innerText = score;
        if (combo > 1) {
            comboDisplay.innerText = `${combo}x Combo!`;
            comboDisplay.style.opacity = 1;
        } else {
            comboDisplay.style.opacity = 0;
            setTimeout(() => { if(combo <= 1) comboDisplay.innerText = ''; }, 200);
        }
    }

    function interpolateColor(color1, color2, factor) {
        if (arguments.length < 3) factor = 0.5;
        let result = color1.slice();
        for (let i = 0; i < 3; i++) {
            result[i] = Math.round(result[i] + factor * (color2[i] - color1[i]));
        }
        return result;
    }

    function hexToRgb(hex) {
        let shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
        hex = hex.replace(shorthandRegex, function(m, r, g, b) { return r + r + g + g + b + b; });
        let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : null;
    }
    
    function rgbToHex(r, g, b) {
        return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }

    function getCurrentBgColors(height) {
        for (let i = 0; i < bgGradients.length - 1; i++) {
            if (height >= bgGradients[i].h && height < bgGradients[i+1].h) {
                let range = bgGradients[i+1].h - bgGradients[i].h;
                let progress = (height - bgGradients[i].h) / range;
                let top1 = hexToRgb(bgGradients[i].top), top2 = hexToRgb(bgGradients[i+1].top);
                let bot1 = hexToRgb(bgGradients[i].bottom), bot2 = hexToRgb(bgGradients[i+1].bottom);
                let curTop = interpolateColor(top1, top2, progress);
                let curBot = interpolateColor(bot1, bot2, progress);
                return { top: rgbToHex(curTop[0], curTop[1], curTop[2]), bottom: rgbToHex(curBot[0], curBot[1], curBot[2]) };
            }
        }
        return { top: bgGradients[bgGradients.length-1].top, bottom: bgGradients[bgGradients.length-1].bottom };
    }

    function drawBackground() {
        let physicalHeight = (state === 'PLAYING' || state === 'MISSED') ? Math.max(0, blocks.length - 1) : 0;
        let colors = getCurrentBgColors(physicalHeight);

        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, colors.top);
        gradient.addColorStop(1, colors.bottom);
        
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        if (physicalHeight > 25) {
            const starOpacity = Math.min(1, (physicalHeight - 25) / 10);
            for(let i=0; i<60; i++) {
                let sx = (i * 97) % canvas.width;
                let sy = ((i * 131) + cameraY * 0.1) % canvas.height; 
                let twinkle = Math.abs(Math.sin(time * 0.01 + i));
                
                ctx.globalAlpha = starOpacity * (0.3 + twinkle * 0.7);
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(sx, sy, (i%3===0)?1.5:1, 0, Math.PI*2);
                ctx.fill();
            }
            ctx.globalAlpha = 1.0;
        }

        if (physicalHeight < 40) {
            const cloudOpacity = Math.max(0, 1 - (physicalHeight - 20) / 20);
            clouds.forEach(cloud => {
                let cy = cloud.y + (cameraY * 0.3); 
                if (cy > canvas.height + 100 || cy < -100) return;
                
                ctx.globalAlpha = cloud.opacity * cloudOpacity;
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(cloud.x, cy, 30 * cloud.scale, 0, Math.PI*2);
                ctx.arc(cloud.x + 25 * cloud.scale, cy - 10 * cloud.scale, 40 * cloud.scale, 0, Math.PI*2);
                ctx.arc(cloud.x + 55 * cloud.scale, cy, 35 * cloud.scale, 0, Math.PI*2);
                ctx.fill();
            });
            ctx.globalAlpha = 1.0;
        }
    }

    function drawBlock(ctx, x, y, width, height, colors) {
        const radius = 6; 
        const isBase = width > BLOCK_WIDTH;

        // Badan Utama
        ctx.fillStyle = colors.main;
        ctx.beginPath();
        ctx.roundRect(-width/2, -height/2, width, height, isBase ? [radius, radius, 0, 0] : [0,0,0,0]);
        ctx.fill();
        
        // Highlight Kiri (Kesan 3D)
        ctx.fillStyle = colors.light;
        ctx.beginPath();
        if(isBase) {
             ctx.roundRect(-width/2, -height/2, width * 0.15, height, [radius, 0, 0, 0]);
        } else {
             ctx.rect(-width/2, -height/2, width * 0.15, height);
        }
        ctx.fill();

        // Bayang Kanan (Kesan 3D)
        ctx.fillStyle = colors.dark;
        ctx.beginPath();
        if(isBase) {
             ctx.roundRect(width/2 - width*0.2, -height/2, width * 0.2, height, [0, radius, 0, 0]);
        } else {
             ctx.rect(width/2 - width*0.2, -height/2, width * 0.2, height);
        }
        ctx.fill();

        // Pemisah atas bawah
        ctx.fillStyle = 'rgba(255,255,255,0.3)';
        ctx.fillRect(-width/2, -height/2, width, 4);
        
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        ctx.fillRect(-width/2, height/2 - 4, width, 4);
        
        // Lukis Tingkap jika bukan base
        if (!isBase) {
            // 5 Baris x 1 Lajur (1x5 Grid)
            const winRows = 5, winCols = 1, winW = 14, winH = 16;
            const paddingX = (width - (winCols * winW)) / (winCols + 1);
            const paddingY = (height - (winRows * winH)) / (winRows + 1);
            
            for(let r=0; r<winRows; r++) {
                for(let c=0; c<winCols; c++) {
                    let wx = (-width/2) + paddingX + c * (winW + paddingX);
                    let wy = (-height/2) + paddingY + r * (winH + paddingY);
                    
                    let windowSeed = Math.sin(x * y * (r+1) * (c+1));
                    
                    ctx.fillStyle = 'rgba(20, 20, 30, 0.8)';
                    ctx.fillRect(wx, wy, winW, winH);
                    
                    if (windowSeed > 0.3) {
                        ctx.fillStyle = '#fef08a'; 
                        ctx.fillRect(wx + 1, wy + 1, winW - 2, winH - 2);
                        ctx.fillStyle = 'rgba(254, 240, 138, 0.3)';
                        ctx.fillRect(wx - 2, wy - 2, winW + 4, winH + 4);
                    } else {
                        ctx.fillStyle = 'rgba(100, 149, 237, 0.3)';
                        ctx.fillRect(wx + 1, wy + 1, winW - 2, winH - 2);
                    }
                }
            }
        } else {
            // Hiasan Pintu untuk Blok Tapak
            ctx.fillStyle = colors.dark;
            ctx.fillRect(-15, height/2 - 30, 30, 30); 
            ctx.fillStyle = '#fef08a';
            ctx.fillRect(-10, height/2 - 38, 20, 6); 
        }
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBackground();

        ctx.save();
        ctx.translate(0, cameraY); 

        // 1. LUKIS BLOK TERSUSUN / TAPAK
        blocks.forEach((block, index) => {
            let drawX = block.x; 

            ctx.save();
            ctx.translate(drawX, block.y + block.height/2); 
            drawBlock(ctx, block.x, block.y, block.width, block.height, block.color);
            ctx.restore();
        });

        // 2. LUKIS BLOK SEMASA & KREN
        if (currentBlock && (state === 'PLAYING' || state === 'MISSED')) {
            if (currentBlock.state === 'SWINGING') {
                const craneY = -cameraY - 120; 
                const ropeLength = 250;       
                
                const blockX = canvas.width/2 + Math.sin(currentBlock.angle) * ropeLength;
                const blockY = craneY + Math.cos(currentBlock.angle) * ropeLength;

                ctx.beginPath();
                ctx.moveTo(canvas.width/2, craneY);
                ctx.lineTo(blockX, blockY);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.fillStyle = '#f59e0b';
                ctx.fillRect(canvas.width/2 - 50, craneY - 30, 100, 30);
                
                ctx.fillStyle = '#000000';
                for(let i=-40; i<50; i+=20) {
                    ctx.beginPath();
                    ctx.moveTo(canvas.width/2 + i, craneY - 30);
                    ctx.lineTo(canvas.width/2 + i - 10, craneY);
                    ctx.lineTo(canvas.width/2 + i, craneY);
                    ctx.lineTo(canvas.width/2 + i + 10, craneY - 30);
                    ctx.fill();
                }

                ctx.fillStyle = '#475569';
                ctx.fillRect(blockX - 15, blockY - 15, 30, 15);
                ctx.beginPath();
                ctx.arc(blockX, blockY - 15, 15, Math.PI, 0);
                ctx.fill();

                ctx.save();
                ctx.translate(blockX, blockY + currentBlock.height/2);
                drawBlock(ctx, blockX, blockY, currentBlock.width, currentBlock.height, currentBlock.color);
                ctx.restore();
            } 
            else if (currentBlock.state === 'FALLING' || currentBlock.state === 'FALLING_OFF') {
                ctx.save();
                ctx.translate(currentBlock.x, currentBlock.y + currentBlock.height/2);
                if (currentBlock.state === 'FALLING_OFF') {
                     ctx.rotate((currentBlock.x > canvas.width/2 ? 1 : -1) * (currentBlock.y * 0.015));
                }
                drawBlock(ctx, currentBlock.x, currentBlock.y, currentBlock.width, currentBlock.height, currentBlock.color);
                ctx.restore();
            }
        }

        ctx.restore(); 
    }

    // --- GAME LOOP DENGAN DELTA TIME ---
    function gameLoop(timestamp) {
        if (!lastTime) lastTime = timestamp;
        let deltaTime = timestamp - lastTime;
        lastTime = timestamp;

        if (deltaTime > 100) deltaTime = 16.66;
        let delta = deltaTime / 16.666;

        if (state !== 'GAMEOVER') {
            update(delta);
            draw();
            requestAnimationFrame(gameLoop);
        } else {
            draw();
        }
    }

    function handleInteraction(e) {
        if (e.type === 'touchstart' || e.type === 'pointerdown') {
            if(e.target !== startBtn && e.target !== restartBtn) {
                 e.preventDefault();
            }
        }
        
        if (state === 'PLAYING') {
            if(e.target.tagName !== 'BUTTON') {
                dropBlock();
            }
        }
    }

    startBtn.addEventListener('click', initGame);
    restartBtn.addEventListener('click', initGame);
    canvas.addEventListener('pointerdown', handleInteraction, {passive: false});
    window.addEventListener('keydown', (e) => {
        if (e.code === 'Space') {
            if (state === 'PLAYING') dropBlock();
            if(e.target === document.body) e.preventDefault();
        }
    });

    initClouds();
    resizeCanvas();

</script>
</body>
</html>
